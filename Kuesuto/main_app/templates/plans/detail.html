{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- Top Action Buttons -->
<div style="display:flex; gap:15px; margin-bottom:30px; flex-wrap:wrap;">
  <a href="{% url 'plans_index' %}" class="btn grey">
    <i class="material-icons left">arrow_back</i>
    BACK TO QUEST LIST
  </a>
  <a href="{% url 'plans_update' plan.id %}" class="btn">
    <i class="material-icons left">edit</i>
    EDIT QUEST
  </a>
  <a href="{% url 'plans_delete' plan.id %}" class="btn red" style="margin-left:auto;">
    <i class="material-icons left">delete</i>
    DELETE
  </a>
</div>

<!-- Quest Header Card -->
<div class="card" style="border: 3px solid var(--neon-purple); padding:40px; margin-bottom:40px;">
  
  <!-- Quest Title & Meta -->
  <div style="display:flex; justify-content:space-between; align-items:center; gap:30px; flex-wrap:wrap; margin-bottom:30px;">
    <div style="flex:1; min-width:300px;">
      <h1 style="font-size:3rem; margin:0 0 15px 0;">{{ plan.name|upper }}</h1>
      <p style="margin:0; font-size:1.1rem; color:var(--space-text-secondary);">
        <strong>DURATION:</strong> {{ plan.duration }} • 
        <strong>{{ plan.task_set.filter.count }} / {{ plan.task_set.count }} TASKS COMPLETE</strong>
      </p>
    </div>
    
    <!-- Color Indicator -->
    <div style="width:80px; height:80px; background-color:{{ plan.color }}; border-radius:15px; border:3px solid var(--neon-cyan); flex-shrink:0;"></div>
  </div>
  
  <!-- Progress Bar -->
  <div>
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
      <span>QUEST PROGRESS</span>
      <span style="color:var(--neon-green); font-weight:700;">
        {% if plan.task_set.count > 0 %}
          {% widthratio plan.task_set.filter.count plan.task_set.count 100 %}% COMPLETE
        {% else %}
          0% COMPLETE
        {% endif %}
      </span>
    </div>
    <div style="width:100%; height:30px; background:var(--space-bg-tertiary); border:2px solid var(--neon-purple); border-radius:15px; overflow:hidden;">
      <div style="height:100%; background:linear-gradient(90deg, var(--neon-green), var(--neon-cyan)); width:{% widthratio plan.task_set.filter.count plan.task_set.count 100 %}%; transition:width 0.5s; display:flex; align-items:center; justify-content:center; box-shadow:0 0 20px rgba(16, 185, 129, 0.6);">
        <span style="color:white; font-weight:900; font-size:0.9rem;">
          {% if plan.task_set.count > 0 %}
            {% widthratio plan.task_set.filter.count plan.task_set.count 100 %}%
          {% endif %}
        </span>
      </div>
    </div>
  </div>
</div>

<!-- Quest Start -->
<div style="display:flex; align-items:center; gap:20px; margin:40px 0;">
  <div style="width:80px; height:80px; background:var(--neon-green); border-radius:15px; display:flex; align-items:center; justify-content:center; box-shadow:0 0 20px rgba(16, 185, 129, 0.5);">
    <i class="material-icons" style="font-size:3rem; color:white;">flag</i>
  </div>
  <div>
    <h3 style="margin:0 0 5px 0; font-size:1.5rem;">QUEST START</h3>
    <p style="margin:0; color:var(--space-text-secondary);">BEGIN!</p>
  </div>
</div>

<!-- Tasks Horizontal Flow - FIXED -->
{% with tasks=plan.task_set.all %}
  {% if tasks %}
    <!-- Horizontal Scroll Container -->
    <div style="display:flex; gap:40px; overflow-x:auto; padding:20px 0; margin:40px 0;">
      {% for task in tasks %}
        
        <!-- Single Task Column -->
        <div style="display:flex; flex-direction:column; align-items:center; flex:0 0 auto; width:320px; min-width:300px;">
          
          <!-- Status Icon Above -->
          <div style="width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:20px; {% if task.is_completed %}background:var(--neon-green);{% else %}background:var(--space-bg-tertiary); border:3px solid var(--space-text-secondary);{% endif %} box-shadow:0 0 15px rgba(168, 85, 247, 0.4);">
            {% if task.is_completed %}
              <i class="material-icons" style="font-size:2.5rem; color:white;">check_circle</i>
            {% else %}
              <i class="material-icons" style="font-size:2.5rem; color:white;">radio_button_unchecked</i>
            {% endif %}
          </div>

          <!-- Task Card -->
          <div class="card {% if task.is_completed %}task-completed{% endif %}" style="border:3px solid {{ task.color }}; margin:0; width:100%;">
            <div class="card-content">
              
              <!-- Title & Star -->
              <div style="display:flex; justify-content:space-between; align-items:start; gap:10px; margin-bottom:15px;">
                <span class="card-title" style="margin:0; font-size:1.1rem; flex:1; line-height:1.3;">
                  {{ task.name|upper }}
                </span>
                {% if task.importance %}
                  <i class="material-icons" style="color:var(--neon-orange); font-size:2rem;">star</i>
                {% endif %}
              </div>

              <!-- Notes -->
              {% if task.notes %}
                <p style="font-size:0.9rem; margin-bottom:15px; color:var(--space-text-secondary);">
                  {{ task.notes|truncatewords:12 }}
                </p>
              {% endif %}

              <!-- Duration -->
              <p style="margin-bottom:8px; font-size:0.9rem;">
                <strong>DURATION:</strong> {{ task.duration }}
              </p>

              <!-- Status -->
              <p style="margin-bottom:20px; font-size:0.9rem;">
                <strong>STATUS:</strong> 
                {% if task.is_completed %}
                  <span style="color:var(--neon-green); font-weight:700;">✓ DONE</span>
                {% else %}
                  <span style="color:var(--neon-cyan); font-weight:700;">○ ACTIVE</span>
                {% endif %}
              </p>

              <!-- Actions -->
              <div style="display:flex; flex-direction:column; gap:10px; padding-top:15px; border-top:2px solid var(--space-bg-tertiary);">
                <form method="post" action="{% url 'task_toggle_complete' task.id %}" style="width:100%;">
                  {% csrf_token %}
                  <button type="submit" class="btn-small {% if task.is_completed %}grey{% else %}green{% endif %}" style="width:100%;">
                    {% if task.is_completed %}
                      <i class="material-icons left">undo</i>
                      UNDO
                    {% else %}
                      <i class="material-icons left">check</i>
                      COMPLETE
                    {% endif %}
                  </button>
                </form>
                
                <a href="{% url 'tasks_detail' task.id %}" class="btn-small" style="width:100%; text-align:center;">
                  <i class="material-icons left">visibility</i>
                  VIEW
                </a>
              </div>
            </div>
          </div>

          <!-- Connector Line Below (if not last) -->
          {% if not forloop.last %}
            <div style="width:40px; height:0; border-top:3px solid var(--neon-cyan); margin-top:-50%; position:absolute; right:-40px; top:50%; display:none;"></div>
          {% endif %}
        </div>

      {% endfor %}
    </div>
  {% else %}
    <!-- Empty State -->
    <div class="card" style="padding:60px; text-align:center;">
      <i class="material-icons" style="font-size:4rem; color:var(--neon-purple); opacity:0.5;">assignment</i>
      <h3 style="margin:20px 0 10px; color:var(--neon-cyan);">NO TASKS YET</h3>
      <p style="color:var(--space-text-secondary); margin-bottom:25px;">This quest has no tasks. Add some tasks to get started!</p>
      <a href="{% url 'plans_update' plan.id %}" class="btn">
        <i class="material-icons left">add</i>
        ADD TASKS
      </a>
    </div>
  {% endif %}
{% endwith %}

<!-- Quest Rewards -->
<div class="card" style="border:3px solid var(--neon-orange); padding:30px; margin-top:60px;">
  <div style="display:flex; align-items:center; gap:30px; flex-wrap:wrap;">
    <div style="width:80px; height:80px; background:var(--neon-orange); border-radius:15px; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:0 0 20px rgba(249, 115, 22, 0.5);">
      <i class="material-icons" style="font-size:3rem; color:white;">emoji_events</i>
    </div>
    <div style="flex:1;">
      <h2 style="margin:0 0 10px; font-size:1.8rem;">QUEST REWARDS</h2>
      <p style="margin:0; font-size:1.1rem;">
        COMPLETE ALL TASKS TO EARN 
        <span style="color:var(--neon-green); font-weight:900; font-size:1.3rem;">{{ plan.task_set.count|add:"0" }} XP</span>
        {% with important_count=plan.task_set.filter.count %}
          {% if important_count > 0 %}
            + <span style="color:var(--neon-orange); font-weight:900; font-size:1.3rem;">{{ important_count|add:"0" }} BONUS XP</span>
            (PRIORITY TASKS)
          {% endif %}
        {% endwith %}
      </p>
    </div>
  </div>
</div>

<!-- Mobile Responsive CSS -->
<style>
/* Horizontal scroll styling */
div[style*="overflow-x:auto"]::-webkit-scrollbar {
  height: 10px;
}

div[style*="overflow-x:auto"]::-webkit-scrollbar-track {
  background: var(--space-bg-tertiary);
  border-radius: 10px;
}

div[style*="overflow-x:auto"]::-webkit-scrollbar-thumb {
  background: var(--neon-purple);
  border-radius: 10px;
}

div[style*="overflow-x:auto"]::-webkit-scrollbar-thumb:hover {
  background: var(--neon-cyan);
}

/* Mobile: Stack vertically */
@media (max-width: 768px) {
  div[style*="overflow-x:auto"] {
    flex-direction: column !important;
    overflow-x: visible !important;
  }
  
  div[style*="overflow-x:auto"] > div {
    width: 100% !important;
  }
}
</style>

{% endblock %}